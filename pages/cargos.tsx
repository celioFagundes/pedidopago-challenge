import type { GetServerSideProps } from 'next'
import Head from 'next/head'
import axios from 'axios'
import { useEffect, useState } from 'react'
import Table from '../components/TestTable'
import { BsThreeDotsVertical } from 'react-icons/bs'
import Layout from '../components/Layout'
import {
  BottomContainerSingle,
  Container,
  Content,
  DropdownActionLabel,
  DropdownIcon,
  DropdownItemData,
  DropdownLabel,
  ListTitle,
  ModalBackground,
  ModalButton,
  ModalMenu,
  ModalOption,
  ModalOptionIcon,
  ModalOptionLink,
  PageTitle,
  Tab,
  Tabs,
  Wrapper,
} from '../styles/styles-test'
import Link from 'next/link'
import { useRouter } from 'next/router'
import SearchInput from '../components/SearchInput'
import Pagination from '../components/Pagination'
import { AiOutlineEye, AiOutlineFileAdd } from 'react-icons/ai'
import { RiDeleteBinLine } from 'react-icons/ri'
import { FiEdit } from 'react-icons/fi'
import { ImStack } from 'react-icons/im'
import SelectModal from '../components/SelectModal'
import { MdOutlineKeyboardArrowDown, MdOutlineKeyboardArrowUp } from 'react-icons/md'
import { ActionsContainer, DotsIcon } from '../styles/styles-test'
interface Roles {
  name: string
  departament: string
  agents_quantity: number
}
interface MainProps {
  data: [Roles]
}

interface IsOpenList {
  [key: string]: boolean
}
const Cargos: React.FC<MainProps> = ({ data }) => {
  const [displayData, setDisplayData] = useState(data)
  const [modalCategoriesIsOpen, setModalCategoriesIsOpen] = useState(false)
  const [modalIsOpenList, setModalIsOpenList] = useState<IsOpenList>({})
  const [dropdownIsOpenList, setDropdownIsOpenList] = useState<IsOpenList>({})
  const router = useRouter()

  useEffect(() => {
    const modalList = displayData.reduce((prev, curr) => {
      return { ...prev, [curr.name + curr.departament]: false }
    }, {})
    setModalIsOpenList(modalList)
  }, [displayData])

  const toggleModal = (key: string) => {
    let newList = { ...modalIsOpenList }
    Object.keys(newList).forEach(item => (newList[item] = false))
    newList[key] = true
    setModalIsOpenList(newList)
  }
  const toggleDropdown = (id: string) => {
    let newList = { ...dropdownIsOpenList }
    if (newList[id]) {
      Object.keys(newList).forEach(item => (newList[item] = false))
    } else {
      Object.keys(newList).forEach(item => (newList[item] = false))
      newList[id] = !newList[id]
    }
    setDropdownIsOpenList(newList)
  }
  const anyModalOpen = () => {
    let isOpen = false
    Object.keys(modalIsOpenList).forEach(item => {
      if (modalIsOpenList[item]) {
        isOpen = true
      }
    })
    return isOpen
  }
  const closeModal = () => {
    if (anyModalOpen()) {
      let newList = { ...modalIsOpenList }
      Object.keys(newList).forEach(item => (newList[item] = false))
      setModalIsOpenList(newList)
    }
  }

  return (
    <div>
      <Head>
        <title>Create Next App</title>
        <meta name='description' content='Generated by create next app' />
        <link rel='icon' href='/favicon.ico' />
      </Head>
      <Layout>
        <Wrapper onClick={closeModal}>
          <Container>
            <PageTitle>Organização</PageTitle>
            <Content>
              <Tabs>
                <Link href='/'>
                  <Tab isActive={router.pathname === '/'}>Colaboradores</Tab>
                </Link>
                <Link href='/cargos'>
                  <Tab isActive={router.pathname !== '/'}>Cargos</Tab>
                </Link>
              </Tabs>
              <SelectModal
                isOpen={modalCategoriesIsOpen}
                openFn={() => setModalCategoriesIsOpen(true)}
                closeFn={() => setModalCategoriesIsOpen(false)}
                label={'Cargos'}
              />
              <SearchInput />
              <ListTitle>Listagem de cargos</ListTitle>
              {data && (
                <Table>
                  <Table.Header>
                    <Table.Row>
                      <Table.Th>Cargo</Table.Th>
                      <Table.Th>Departamento</Table.Th>
                      <Table.Th>Colaboradores</Table.Th>
                      <Table.Th></Table.Th>
                    </Table.Row>
                  </Table.Header>
                  <Table.Body>
                    {data.map(role => (
                      <Table.Row
                        key={role.name + role.departament}
                        isActive={dropdownIsOpenList[role.name + role.departament]}
                        maxHeight={'70px'}
                      >
                        <Table.Td onClick={() => toggleDropdown(role.name + role.departament)}>
                          <DropdownLabel>Cargo</DropdownLabel>
                          <DropdownItemData>{role.name}</DropdownItemData>
                          <DropdownIcon>
                            {!dropdownIsOpenList[role.name + role.departament] ? (
                              <MdOutlineKeyboardArrowDown />
                            ) : (
                              <MdOutlineKeyboardArrowUp />
                            )}
                          </DropdownIcon>
                        </Table.Td>
                        <Table.Td>
                          <DropdownLabel>Departamento</DropdownLabel>
                          <DropdownItemData>{role.departament}</DropdownItemData>
                        </Table.Td>
                        <Table.Td>
                          <DropdownLabel>Colaboradores</DropdownLabel>
                          <DropdownItemData>{role.agents_quantity}</DropdownItemData>
                        </Table.Td>
                        <Table.Td>
                          <ModalButton onClick={() => toggleModal(role.name + role.departament)}>
                            <DotsIcon>
                              <BsThreeDotsVertical size={16} />
                            </DotsIcon>
                            <ActionsContainer>
                              <AiOutlineFileAdd size={24} color='#1DD195' />
                              <DropdownActionLabel>Ações</DropdownActionLabel>
                            </ActionsContainer>
                          </ModalButton>
                          <>
                            <ModalBackground
                              isOpen={modalIsOpenList[role.name + role.departament]}
                            />
                            <ModalMenu isOpen={modalIsOpenList[role.name + role.departament]}>
                              <Link href={`/cargo/create`}>
                                <ModalOption>
                                  <ModalOptionIcon>
                                    <AiOutlineEye size={22} />
                                  </ModalOptionIcon>
                                  <ModalOptionLink isActive={true}>Ver cargo</ModalOptionLink>
                                </ModalOption>
                              </Link>
                              <Link href='#'>
                                <ModalOption>
                                  <ModalOptionIcon>
                                    <FiEdit size={22} />
                                  </ModalOptionIcon>
                                  <ModalOptionLink isActive={false}>Editar</ModalOptionLink>
                                </ModalOption>
                              </Link>
                              <Link href='#'>
                                <ModalOption>
                                  <ModalOptionIcon>
                                    <ImStack size={22} />
                                  </ModalOptionIcon>
                                  <ModalOptionLink isActive={false}>Duplicar</ModalOptionLink>
                                </ModalOption>
                              </Link>
                              <Link href='#'>
                                <ModalOption>
                                  <ModalOptionIcon>
                                    <RiDeleteBinLine size={22} />
                                  </ModalOptionIcon>
                                  <ModalOptionLink isActive={false}>Excluir</ModalOptionLink>
                                </ModalOption>
                              </Link>
                            </ModalMenu>
                          </>
                        </Table.Td>
                      </Table.Row>
                    ))}
                  </Table.Body>
                </Table>
              )}
              <BottomContainerSingle>
                <Pagination />
              </BottomContainerSingle>
            </Content>
          </Container>
        </Wrapper>
      </Layout>
    </div>
  )
}

export const getServerSideProps: GetServerSideProps = async context => {
  const { data } = await axios.get('https://pp-api-desafio.herokuapp.com/roles')
  return {
    props: {
      data: data.roles,
    },
  }
}

export default Cargos
